# This is a basic workflow to help you get started with Actions

name: detekt

on:
  pull_request:
    branches: [ "main" ]

env:
  JDK_VERSION: 17
  GRADLE_VERSION: 8.10.1
  PGHOST: postgres
  PGPORT: 5432
  PGPASSWORD: postgres
  PGUSER: runner
  PGOPTIONS: '--client-min-messages=warning'

jobs:
  detekt:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JDK_VERSION }}
    - name: Run detekt
      uses: gradle/actions/setup-gradle@v3
      with:
        arguments: --no-daemon detekt
        gradle-version: ${{ env.GRADLE_VERSION }}
  ci:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
          distribution: 'temurin'
          java-version: ${{ env.JDK_VERSION }}
    - name: Build docker image
      uses: gradle/actions/setup-gradle@v3
      with:
        arguments: --no-daemon jibDockerBuild
        gradle-version: ${{ env.GRADLE_VERSION }}
    - name: Run application and database
      run: | 
        docker-compose up -d
        docker-compose ps
        while ! pg_isready -h localhost -p 15432 -U runner -d postgres; do
          sleep 1
        done
        if [ "$(docker inspect -f '{{.State.Running}}' $(docker-compose ps -q))" != "true" ]; then
          echo "Docker container failed to start"
          exit 1
        fi
        docker-compose down
    # - name: Run integration tests
    #   uses: gradle/actions/setup-gradle@v3
    #   with:
    #     # TODO: Separate the integration tests from the unit tests in future
    #     arguments: --no-daemon test
    #     gradle-version: ${{ env.GRADLE_VERSION }}